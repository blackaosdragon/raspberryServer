const express = require('express');
const app = express();
const https = require('https');
const fs = require('fs');
const path = require('path');
const bodyParser = require('body-parser');
const admin = require('firebase-admin');
const serviceAccount = require("/home/ubuntu/home-8bea3-firebase-adminsdk-ilfkz-544a451f7b.json");
const mysql = require('mysql');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: 'https://home-8bea3.firebaseio.com/'
});

const dataBase = mysql.createConnection({
 host: 'localhost',
 user: 'infoUpdater',
 password: '107005205',
 database: 'tokens'
});

/* prueba de conexion a base de datos
dataBase.connect( error => {
 if (error){
  console.log('Error: ',error);
 } else {
  console.log('Conexion exitosa a la base de datos');
 }
})
*/

const tokensRegistrados =  "coB2bWwL-HbrVSa2ItiJQY:APA91bGuBtz2d6PIbk4YoM-9yf_J4Xue9T9L0XRez4fuCumii5GxTkt5IFesUvmqZegPUnWWa1Dnx9_NSM5XF-Yhg5rL80oyu10ZQGvYUerKdqucN3up3fbqnnmpUxZ3wqo3GY629UEr";
const registrationToken =  "coB2bWwL-HbrVSa2ItiJQY:APA91bGuBtz2d6PIbk4YoM-9yf_J4Xue9T9L0XRez4fuCumii5GxTkt5IFesUvmqZegPUnWWa1Dnx9_NSM5XF-Yhg5rL80oyu10ZQGvYUerKdqucN3up3fbqnnmpUxZ3wqo3GY629UEr";
const  tokenChrome = "cus1e2pFuv0wn6LRWrtdcM:APA91bEsJooQguI_XOmiTqhCAaxHIiKYrPZKx-94W2Hal2ZSCag_RxlmwvY6g-eLJFDOFO_jxRvQ3nH9Ht1Dt76K-o5K3PCy-R8hTsHAad0IUqOxndiLIt2NkmOzmb6F_9rF2mGStl_6";
//const tokenChrome2 = "cus1e2pFuv0wn6LRWrtdcM:APA91bFwnPuLwqv2MqIswTWdBHW3rMrADc8imHKpoQvNhXq3HQDq_jwa2F6ZqZ_FPuyx3hbFUov6LOd6f22oMli4RW3FRMuEySSBo3mqpXaY7j05JrmJFwVD1qletZrrVUz89Or6Erkb"
//const tokenChrome2="coB2bWwL-HbrVSa2ItiJQY:APA91bGeafuHs3FgNr3tAPePIWq85hLOs-rOy57yRccyMGQqkJl3FmCZA9q8XqnIRSflPewl5y06SR354Nl-7tY20ZOL04mr9ul_p7Gmwtn_-81L7oRzMqkvoGA7hpL3UWvPA3uU3apC"
const tokenChrome2="ftno8SPYtB2sxe1wjTOAgA:APA91bF1ltSIrXod8teDysScanKxQjfPv3plr8C1uotGfFdvRS9q8CkVn7d3x2JBdK8257GL-55F1ZRZSPEuv095FR9HO_jLY4iyP-TaF8LNMplOAXbSkuq4W3_rOYmydVyqfcBh3a-J"

//const tokenChrome2 = "cus1e2pFuv0wn6LRWrtdcM:APA91bFwnPuLwqv2MqIswTWdBHW3rMrADc8imHKpoQvNhXq3HQDq_jwa2F6ZqZ_FPuyx3hbFUov6LOd6f22oMli4RW3FRMuEySSBo3mqpXaY7j05JrmJFwVD1qletZrrVUz89Or6Erkb";
const tokenChrome3 = "cus1e2pFuv0wn6LRWrtdcM:APA91bFwnPuLwqv2MqIswTWdBHW3rMrADc8imHKpoQvNhXq3HQDq_jwa2F6ZqZ_FPuyx3hbFUov6LOd6f22oMli4RW3FRMuEySSBo3mqpXaY7j05JrmJFwVD1qletZrrVUz89Or6Erkb";
let dataGlobal = "";

//libreria del puerto serial
const puerto = 443; //puerto por donde se encuentra el servidor
/*
const server = app.listen(puerto,()=>{
  console.log(`Servidor abierto en el puerto ${puerto}`);
});
*/

const httpServer = https.createServer({
 key: fs.readFileSync(path.resolve('/home/ubuntu/privkey.pem')),
 cert: fs.readFileSync(path.resolve('/home/ubuntu/cert.pem'))

},app)

httpServer.listen(puerto,()=>{
 console.log(`Servidor disponible en el puerto ${puerto}`);
})

const SerialPort = require('serialport');
const Readline = SerialPort.parsers.Readline;
const port = new SerialPort('/dev/ttyUSB0');
//const parser = port.pipe(new ReadLine({delimiter: '\r\n'}));
const parser = port.pipe(new Readline({delimiter: '\r\n'}));
const io = require('socket.io')(httpServer);

// este es elcodigo anterior que si funciona

let tempString = "";
let tempFloat = 0.0;
let payload = {
  data: {
    MyKey1: "Alerta",
  },
};
let options = {
  priority: "high",
  timeToLive: 60*60*24
  }


admin.messaging().sendToDevice(tokenChrome3,payload,options).then( response => {
  console.log('Mensaje satisfactorio: ',response);
}).catch( err => {
  console.log('Error: ',err);
});
var message = {
 data: {
  data: 'test',
  info: 'prueba'
 },
 token: tokenChrome2
};

admin.messaging().send(message)
.then(response=>{
console.log("Mensaje satisfactorio: ",response);
})
.catch(error => {
 console.log("Error mandando mensaje: ",error);
})

parser.on('data',(temp)=>{
 dataGlobal = temp;
 io.emit('temp',temp);
 for (let i = 15; i <= 18; i++){
   tempString = tempString+dataGlobal[i];
 }
 tempFloat = parseFloat(tempString);
 if (tempFloat > 25.0 && tempFloat < 27.9){
   //console.log("Notificacion de precaucion");
   let notifiOficina = {
     notification: {
      title: "Advertencia",
      body: `La temperatura supera los ${tempFloat}Â°C revisar el sensor`
     }
 /*
 admin.messaging().sendToDevice(<Token de registro>,notifiJSON,options).then(response=>{
console.log("Satisfactorio el envio de mensaje",response);
}).catch((err)=>{
console.log("Error al enviar mensaje", err);
})

 */
   }
 } else if (temp > 28.0){
  console.log("Notificacion de alerta");
}
 //console.log(tempFloat);
 tempString = "";
})



//nuevo codigo
/*
parser.on('data',temp =>{
 console.log(datoGlobal);
 io.emit('temp',{ temperatura: temp });
 })
*/



app.use(function(req,res,next){
  res.setHeader('Access-Control-Allow-Origin','*');
  res.header('Access-Control-Allow-Headers', 'Authorization, X-API-KEY, Origin, X-Requested-With, Content-Type, Accept, Access-COntrol-Allow-Request-Method');
  res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, DELETE');
  res.header('Allow', 'GET, POST, OPTIONS, PUT, DELETE');
  next();
});
app.use(express.static(__dirname + '/public'));
app.use(bodyParser.urlencoded({extend: false}));
app.use(bodyParser.json());

let dataSensor = {
 sensor: 'Taller',
 ubicacion: 'Planta baja',
}
let sensorVariable = {
 sensor: 'Bodega',
 ubicacion: 'Planta baja'
}

app.post('/token',function(req,res){
 let token = req.body.token;
 dataBase.connect();
 dataBase.query("SELECT * FROM Tokens",(error,resultado,campos) => {
 console.log("Resultados: ",resultado);
 console.log(resultado[0]);
 for(let i=0; resultado.length > i; i++){
  if(resultado[i].token){
   console.log("Ya exist el token");
  } else
 }

 console.log("Campos: ",campos);
 /*
 if(RowDataPacket.token==token){
  console.log("Token coincide");
 } else {
 console.log("Ningun token coincide");
 }*/
// for(let contador=0; contador)
/*  if(error){
   console.log("Error: ",error);
  }
  
  Object.keys(resultado).forEach( key => {
   let row = resultado[key];
   if(row.name==token){
    console.log("El token ya existe")
   }else{
     dataBase.query(`INSERT INTO Tokens (usuario,token) VALUES (NULL,'${token}')`);
   }

  })*/
 });
 console.log("Token: ",token);
 //dataBase.connect();
 //dataBase.end();
 res.end("yes");
})

app.get('/sensor',function (req,res){
 //res.send(dataGlobal[4])
 if(dataGlobal[4]==='1'){
  let sValor = "";
  let fValor = 0;
 for(let i = 15; i <= 18; i++){
  sValor = sValor + dataGlobal[i];
 }
  //takeValor(sValor,dataGlobal);
  fValor = parseFloat(sValor);
  let registro = new Date;
  let response = {
  temperatura: fValor,
  info: dataSensor,
  fecha: registro.getMonth() + " / " + registro.getDate() + " / " + registro.getFullYear(),
  hora: registro.getHours() + ":" + registro.getMinutes() + ":" + registro.getSeconds()
  }
 res.send(response);
 }
 if(dataGlobal[4]==='3'){
  let sValor = "";
  let fValor = 0;
  let registro = new Date;
  for (let i = 15; i <= 18; i++){
   sValor = sValor + dataGlobal[i];
   fValor = parseFloat(sValor);
  }
  let response = {
   temperatura: fValor,
   info: sensorVariable,
   fecha: registro.getMonth() + " / " + registro.getDate() + " / " + registro.getFullYear(),
   hora: registro.getHours() + ":" + registro.getMinutes() + ":" + registro.getSeconds()
  }
 res.send(response);
 }
 if(dataGlobal[4]==='2'){
  let sValor = "";
  let fValor = 0;
  let registro = new Date;
  for (let i = 15; i<=18; i++){
    sValor = sValor + dataGlobal[i];
    fValor = parseFloat(sValor);
  }
   let response = {
   temperatura: fValor,
   info: sensorVariable,
   fecha: registro.getMonth() + " / " + registro.getDate() + " / " + registro.getFullYear(),
   hora: registro.getHours() + ":" + registro.getMinutes() + ":" + registro.getSeconds()
  }
  res.send(response);
 }

})

/*
function takeValor(sValor,dataGlobal){
 for(let i = 15; i <= 19; i++){
  sValor = sValor + dataGlobal[i];
 }
}
*/
